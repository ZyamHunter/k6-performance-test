on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "fix/**"
      - "release/**"
    paths-ignore:
      - "**/*.md"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "**/*.md"
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'both'
        type: choice
        options:
        - load
        - spike
        - both

name: K6 Performance Tests

env:
  app_name: "k6-performance-test"
  target_url: "https://www.blazedemo.com"

jobs:
  ci_performance:
    name: CI - K6 Performance Test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup K6
        uses: grafana/setup-k6-action@v1
        
      - name: ğŸ“ Create Reports Directory
        run: mkdir -p reports
        
      - name: ğŸ§ª Run Load Test
        if: github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'both' || github.event.inputs.test_type == ''
        run: |
          echo "ğŸš€ Starting Load Test (Target: 250 RPS, p90 < 2s)"
          k6 run --config config/load-test.json --out json=reports/load-test-results.json src/main.js
        continue-on-error: true
        
      - name: âš¡ Run Spike Test
        if: github.event.inputs.test_type == 'spike' || github.event.inputs.test_type == 'both' || github.event.inputs.test_type == ''
        run: |
          echo "âš¡ Starting Spike Test (Peak load validation)"
          k6 run --config config/spike-test.json --out json=reports/spike-test-results.json src/main.js
        continue-on-error: true
        
      - name: ğŸ“Š Extract Test Metrics
        if: always()
        run: |
          # Extract key metrics from JSON reports if they exist
          if [ -f "reports/load-test-results.json" ]; then
            echo "LOAD_TEST_RPS=$(cat reports/load-test-results.json | tail -1 | jq -r '.metric == "http_reqs" and .type == "Point" | .data.value // 0')" >> $GITHUB_ENV
            echo "LOAD_TEST_P90=$(cat reports/load-test-results.json | tail -1 | jq -r '.metric == "http_req_duration" and .type == "Point" and .data.tags.expected_response == "true" | .data.value // 0')" >> $GITHUB_ENV
          fi
          
          if [ -f "reports/spike-test-results.json" ]; then
            echo "SPIKE_TEST_RPS=$(cat reports/spike-test-results.json | tail -1 | jq -r '.metric == "http_reqs" and .type == "Point" | .data.value // 0')" >> $GITHUB_ENV
          fi
        
      - name: â¬†ï¸ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-performance-reports-${{ github.run_number }}
          path: reports/
          retention-days: 30
          
      - name: ï¿½ Generate Test Summary
        if: always()
        run: |
          echo "## ğŸ¯ K6 Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Test Overview" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Site**: https://www.blazedemo.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Scenario**: Flight booking complete flow" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ Test Status" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status | Target | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|-------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "reports/load-test-results.json" ]; then
            echo "| ğŸ”„ Load Test | âœ… Completed | 250 RPS, p90<2s | Check artifacts for details |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ”„ Load Test | â­ï¸ Skipped | - | Not selected for this run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "reports/spike-test-results.json" ]; then
            echo "| âš¡ Spike Test | âœ… Completed | Peak validation | Check artifacts for details |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âš¡ Spike Test | â­ï¸ Skipped | - | Not selected for this run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Reports**: Download `k6-performance-reports-${{ github.run_number }}` artifact" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON Data**: Raw K6 metrics for further analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” How to Analyze Results" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Use K6 HTML reporter or analyze JSON data" >> $GITHUB_STEP_SUMMARY
          echo "3. Check SLA compliance (p90 < 2000ms)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Performance tests executed with K6 on BlazDemo flight booking scenario*" >> $GITHUB_STEP_SUMMARY
