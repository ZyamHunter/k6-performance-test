name: K6 Performance Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'both'
        type: choice
        options:
        - load
        - spike
        - both

env:
  app_name: 'k6-performance-test'
  target_url: 'https://www.blazedemo.com'

jobs:
  validate:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check Required Files
        run: |
          echo 'Validating project structure...'
          if [ ! -f 'src/main.js' ]; then
            echo 'Missing src/main.js'
            exit 1
          fi
          if [ ! -f 'config/load-test.json' ]; then
            echo 'Missing config/load-test.json'
            exit 1
          fi
          if [ ! -f 'config/spike-test.json' ]; then
            echo 'Missing config/spike-test.json'
            exit 1
          fi
          echo 'All required files present'
          
      - name: Setup K6 for Validation
        uses: grafana/setup-k6-action@v1
        
      - name: Test Script Syntax
        run: |
          echo 'Testing K6 script syntax...'
          k6 run --vus 1 --duration 5s src/main.js --dry-run

  ci_performance:
    name: CI - K6 Performance Test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup K6
        uses: grafana/setup-k6-action@v1
        
      - name: Create Reports Directory
        run: mkdir -p reports
        
      - name: Run Load Test
        if: github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'both' || github.event.inputs.test_type == ''
        run: |
          echo 'Starting Load Test'
          k6 run --config config/load-test.json --out json=reports/load-test-results.json src/main.js
        continue-on-error: true
        
      - name: Run Spike Test
        if: github.event.inputs.test_type == 'spike' || github.event.inputs.test_type == 'both' || github.event.inputs.test_type == ''
        run: |
          echo 'Starting Spike Test'
          k6 run --config config/spike-test.json --out json=reports/spike-test-results.json src/main.js
        continue-on-error: true
        
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-performance-reports
          path: reports/
          retention-days: 30